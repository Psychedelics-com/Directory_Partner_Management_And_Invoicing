# Система Автоматизации Партнерских Ретритов
## Технический Обзор Проекта

### 1. Общее Описание
Этот проект представляет собой автоматизированную систему управления партнерами для Psychedelics.com. Система решает проблему ручного управления комиссиями, отчетностью и инвойсингом для 250+ ретрит-центров.

**Ключевая цель**: Полная автоматизация ежемесячного цикла отчетности и выставления счетов, сокращение ручной работы с 8 часов до 15 минут в месяц.

### 2. Архитектура Системы

**Стек технологий:**
- **Backend**: Node.js (Express)
- **Database**: PostgreSQL
- **Frontend**: Vanilla JS + HTML/CSS (Dashboard)
- **Integrations**: PayPal API (Invoicing), Gmail API (Sending reports), Google OAuth (Admin Auth)

**Основные компоненты:**
1.  **Admin Dashboard**: Единый центр управления партнерами, инвойсами и настройками.
2.  **Partner Portal**: Внешний интерфейс для партнеров (без логина, доступ по уникальному токену) для верификации бронирований.
3.  **Scheduler Service**: Автоматический планировщик задач (cron jobs) для рассылки отчетов и проверки оплат.
4.  **Invoice Service**: Логика расчета комиссий и генерации инвойсов.

### 3. Ключевые Бизнес-Процессы

#### А. Ежемесячная Отчетность (День 10)
1.  Администратор загружает CSV с данными по трафику.
2.  Система автоматически рассылает персонализированные письма всем партнерам.
3.  Письмо содержит уникальную ссылку на **Partner Portal**.

#### Б. Верификация и Управление Бронированиями
Партнер переходит на портал, где видит:
-   **Прошлые 3 месяца**: Ретриты, требующие подтверждения (Completed/Canceled).
-   **Будущие 12 месяцев**: Предстоящие бронирования (можно перенести или отменить).
-   **Новая функция**: Возможность добавить новое бронирование вручную ("Report New Booking").

#### В. Моментальный Инвойсинг (Real-time)
Как только партнер отправляет форму верификации:
1.  Система проверяет завершенные ретриты.
2.  Если ретрит завершен более 30 дней назад -> **Генерируется консолидированный инвойс**.
3.  Инвойс отправляется через PayPal API мгновенно.
4.  **Условия оплаты**: 72 часа с момента выставления.

#### Г. Гибкая Система Комиссий
Для каждого партнера можно настроить:
-   **Percentage**: % от выручки (по умолчанию 15%).
-   **Flat Rate**: Фиксированная сумма за бронирование (например, $200).
-   Настраивается через Admin Dashboard.

### 4. Структура Базы Данных (Ключевые Таблицы)

-   `partners`: Основная информация, настройки комиссии (`commission_type`, `flat_rate_amount`).
-   `retreat_bookings`: Все бронирования (статусы: scheduled, completed, canceled).
-   `invoices`: Консолидированные инвойсы.
-   `invoice_line_items`: Детализация инвойса (конкретные бронирования внутри одного счета).
-   `verification_forms`: История отправленных форм и токенов.

### 5. API Эндпоинты (Новые)

-   `POST /api/verification/submit-booking/:token` - Партнер добавляет бронирование.
-   `POST /api/admin/partners` - Создание партнера с настройками комиссий.
-   `GET /api/invoices/detailed` - Получение инвойсов с детализацией.

### 6. Статус Проекта
Система полностью реализована и готова к эксплуатации.
-   ✅ Автоматическая рассылка отчетов
-   ✅ Портал партнера (верификация + управление будущим)
-   ✅ Real-time инвойсинг через PayPal
-   ✅ Админ-панель с аналитикой и управлением
-   ✅ Уведомления о просроченных платежах

### 7. Инструкция для Разработчика
1.  **Развертывание**: Стандартное Node.js приложение. Требуется PostgreSQL и переменные окружения (PayPal Client ID/Secret, Google Credentials).
2.  **Миграции**: SQL скрипты находятся в папке `database/`.
3.  **Логи**: Система пишет логи в консоль и (опционально) в таблицу `email_activity_log`.

---
*Документ подготовлен для передачи ведущему разработчику.*
